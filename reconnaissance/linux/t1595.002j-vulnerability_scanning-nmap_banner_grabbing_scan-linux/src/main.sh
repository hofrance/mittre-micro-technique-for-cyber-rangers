#!/bin/bash

# T1595_002J - vulnerability_scanning-nmap_banner_grabbing_scan
# MITRE ATT&CK Enterprise - Reconnaissance Tactic (TA0043)
# ATOMIC ACTION: Comprehensive network scanning using Banner Grabbing ONLY
# Platform: Linux | Contract: One action, one dependency, one privilege tier
#  T1595_002J

# FUNCTION 1/4 : CONFIGURATION AND PRECONDITION VALIDATION

function Get-Configuration {
    echo "[DEBUG] Loading configuration for T1595_002J" >&2

    # Core Configuration
        # Variable TARGETS critique - vérification ajoutée
    export T1595_002j_OUTPUT_BASE="${T1595_002J_OUTPUT_BASE:-/tmp/mitre_results}"
    export T1595_002j_OUTPUT_MODE="${T1595_002J_OUTPUT_MODE:-simple}"
    export T1595_002j_SILENT_MODE="${T1595_002J_SILENT_MODE:-false}"

    # Comprehensive Scanning Configuration
    export T1595_002j_SERVICE_DETECTION="${T1595_002J_SERVICE_DETECTION:-true}"
    export T1595_002j_VERSION_SCANNING="${T1595_002J_VERSION_SCANNING:-true}"
    export T1595_002j_OS_DETECTION="${T1595_002J_OS_DETECTION:-true}"
    export T1595_002j_SCRIPT_SCANNING="${T1595_002J_SCRIPT_SCANNING:-false}"

    # Performance & Timing
    export T1595_002j_TIMING_TEMPLATE="${T1595_002J_TIMING_TEMPLATE:-normal}"
    export T1595_002j_RATE_LIMIT="${T1595_002J_RATE_LIMIT:-0}"
    export T1595_002j_HOST_TIMEOUT="${T1595_002J_HOST_TIMEOUT:-30}"
    export T1595_002j_PARALLELISM="${T1595_002J_PARALLELISM:-5}"

    # Advanced Options
        # Variable CUSTOM_FLAGS critique - vérification ajoutée
    export T1595_002j_EXCLUDE_HOSTS="${T1595_002J_EXCLUDE_HOSTS:-}"
    export T1595_002j_RESOLVE_HOSTNAMES="${T1595_002J_RESOLVE_HOSTNAMES:-true}"
    export T1595_002j_SCRIPT_CATEGORIES="${T1595_002J_SCRIPT_CATEGORIES:-}"

    # Validation des paramètres critiques
    if [[ -z "$T1595_002J_TARGETS" ]]; then
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] T1595_002J_TARGETS is required" >&2
        return 1
    fi

    # Création répertoire de sortie
    local timestamp=$(date +%Y%m%d_%H%M%S)
    export T1595_002j_RESULTS_DIR="$T1595_002J_OUTPUT_BASE/T1595_002J_${timestamp}"
    mkdir -p "$T1595_002J_RESULTS_DIR" 2>/dev/null || {
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] Cannot create output directory" >&2
        return 1
    }

    return 0

    # ===== VÉRIFICATIONS VARIABLES CRITIQUES =====
    
    # Vérification TARGETS (si utilisée)
    if grep -q "TARGETS" "../reconnaissance/linux/t1595.002j-vulnerability_scanning-nmap_banner_grabbing_scan-linux/src/main.sh" && [[ -z "${T1595_002J_TARGETS:-}" ]]; then
        echo "Error: TARGET parameter is required. Please specify target hosts or networks." >&2
        echo "Usage: T1595_002J_TARGETS='192.168.1.0/24' $0" >&2
        return 1
    fi
    
    # Vérification WORDLIST (si utilisée)
    if grep -q "WORDLIST" "../reconnaissance/linux/t1595.002j-vulnerability_scanning-nmap_banner_grabbing_scan-linux/src/main.sh" && [[ -z "${T1595_002J_WORDLIST:-}" ]]; then
        echo "Error: WORDLIST parameter is required for scanning." >&2
        return 1
    fi
    
    # Export des variables critiques si elles existent
    [[ -n "${T1595_002J_TARGETS:-}" ]] && export T1595_002J_TARGETS="$T1595_002J_TARGETS"
    [[ -n "${T1595_002J_WORDLIST:-}" ]] && export T1595_002J_WORDLIST="$T1595_002J_WORDLIST"
    
    # ===== FIN VÉRIFICATIONS CRITIQUES =====


    # ===== VARIABLES ESSENTIELLES RECONNAISSANCE =====
    export T1595_002J_DEBUG_MODE="${T1595_002J_DEBUG_MODE:-false}"
    export T1595_002J_TIMEOUT="${T1595_002J_TIMEOUT:-300}"
    export T1595_002J_FALLBACK_MODE="${T1595_002J_FALLBACK_MODE:-simulation}"
    export T1595_002J_OUTPUT_FORMAT="${T1595_002J_OUTPUT_FORMAT:-json}"
    export T1595_002J_POLICY_CHECK="${T1595_002J_POLICY_CHECK:-true}"
    export T1595_002J_RATE_LIMIT="${T1595_002J_RATE_LIMIT:-10}"
    export T1595_002J_MAX_HOSTS="${T1595_002J_MAX_HOSTS:-254}"
    export T1595_002J_SCAN_DEPTH="${T1595_002J_SCAN_DEPTH:-basic}"
    export T1595_002J_TIMING_TEMPLATE="${T1595_002J_TIMING_TEMPLATE:-normal}"
    export T1595_002J_SERVICE_DETECTION="${T1595_002J_SERVICE_DETECTION:-true}"
    # ===== FIN VARIABLES RECONNAISSANCE =====

}
# FUNCTION 2/4 : PRECONDITION CHECK

function Precondition-Check {
    echo "[DEBUG] Checking preconditions for T1595_002J" >&2

    # Vérification OS
    if [[ "$OSTYPE" != "linux-gnu"* ]]; then
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] This technique requires Linux" >&2
        return 2
    fi

    # Vérification outils
    if [[ "nmap" == "nmap" ]]; then
        if ! command -v nmap &> /dev/null; then
            [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] nmap is required but not installed" >&2
            return 2
        fi

        # Vérification version nmap
        local nmap_version=$(nmap --version | head -1 | grep -oP '\d+\.\d+')
        if [[ "$(echo "$nmap_version < 7.0" | bc -l)" -eq 1 ]]; then
            [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[WARNING] nmap version $nmap_version detected, 7.0+ recommended" >&2
        fi
    elif [[ "nmap" == "zmap" ]]; then
        if ! command -v zmap &> /dev/null; then
            [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] zmap is required but not installed" >&2
            return 2
        fi
    fi

    # Vérification réseau
    if ! ping -c 1 -W 1 8.8.8.8 &> /dev/null; then
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[WARNING] No internet connectivity detected" >&2
    fi

    # Vérification permissions
    if [[ "$T1595_002J_SCRIPT_SCANNING" == "true" ]] && [[ $EUID -ne 0 ]]; then
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[WARNING] NSE scripts may require root privileges" >&2
    fi

    # Validation des fichiers cibles
    if [[ -f "$T1595_002J_TARGETS" ]]; then
        if [[ ! -r "$T1595_002J_TARGETS" ]]; then
            [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] Target file not readable" >&2
            return 2
        fi
    fi

    return 0
}
# FUNCTION 3/4 : ATOMIC ACTION

function Atomic-Action {
    echo "[DEBUG] Executing atomic action for T1595_002J" >&2

    local scan_results="$T1595_002J_RESULTS_DIR/scan_results.json"
    local technical_details="$T1595_002J_RESULTS_DIR/technical_details.xml"
    local nse_results="$T1595_002J_RESULTS_DIR/nse_results.json"
    local scan_start=$(date +%s)

    # Construction des flags selon l'outil
    local cmd=""
    local output_flags=""

    if [[ "nmap" == "nmap" ]]; then
        cmd="nmap -sV -p- -T3 --script=banner"

        # Configuration service detection
        if [[ "$T1595_002J_SERVICE_DETECTION" == "true" ]]; then
            cmd="$cmd -sV"
        fi

        # Configuration version scanning
        if [[ "$T1595_002J_VERSION_SCANNING" == "true" ]]; then
            cmd="$cmd --version-intensity 7"
        fi

        # Configuration OS detection
        if [[ "$T1595_002J_OS_DETECTION" == "true" ]]; then
            cmd="$cmd -O"
        fi

        # Configuration script scanning
        if [[ "$T1595_002J_SCRIPT_SCANNING" == "true" ]]; then
            if [[ -n "$T1595_002J_SCRIPT_CATEGORIES" ]]; then
                cmd="$cmd --script=$T1595_002J_SCRIPT_CATEGORIES"
            else
                cmd="$cmd --script=default"
            fi
        fi

        # Configuration timing
        case "$T1595_002J_TIMING_TEMPLATE" in
            "normal")
                cmd="$cmd -T3"
                ;;
            "aggressive")
                cmd="$cmd -T4"
                ;;
            "insane")
                cmd="$cmd -T5"
                ;;
        esac

        # Configuration rate limiting
        if [[ "$T1595_002J_RATE_LIMIT" != "0" ]]; then
            cmd="$cmd --max-rate $T1595_002J_RATE_LIMIT"
        fi

        # Configuration host timeout
        cmd="$cmd --host-timeout $T1595_002J_HOST_TIMEOUT"

        # Configuration parallélisme
        cmd="$cmd --min-parallelism $T1595_002J_PARALLELISM --max-parallelism $T1595_002J_PARALLELISM"

        # Configuration exclusions
        if [[ -n "$T1595_002J_EXCLUDE_HOSTS" ]]; then
            cmd="$cmd --exclude $T1595_002J_EXCLUDE_HOSTS"
        fi

        # Configuration résolution DNS
        if [[ "$T1595_002J_RESOLVE_HOSTNAMES" == "false" ]]; then
            cmd="$cmd -n"
        fi

        # Flags personnalisés
        if [[ -n "$T1595_002J_CUSTOM_FLAGS" ]]; then
            cmd="$cmd $T1595_002J_CUSTOM_FLAGS"
        fi

        # Cibles et outputs
        cmd="$cmd $T1595_002J_TARGETS"
        output_flags="-oX $technical_details -oG $T1595_002J_RESULTS_DIR/grepable_output.txt"

    elif [[ "nmap" == "zmap" ]]; then
        cmd="zmap -sV -p- -T3 --script=banner"

        # Configuration rate limiting (Zmap specific)
        if [[ "$T1595_002J_RATE_LIMIT" != "0" ]]; then
            cmd="$cmd --rate=$T1595_002J_RATE_LIMIT}"
        fi

        # Configuration output
        cmd="$cmd -o $T1595_002J_RESULTS_DIR/zmap_results.csv"

        # Cibles
        cmd="$cmd $T1595_002J_TARGETS"
    fi

    # Exécution du scan
    [[ "$T1595_002J_OUTPUT_MODE" == "debug" ]] && echo "[DEBUG] Executing: $cmd $output_flags" >&2

    if [[ "nmap" == "nmap" ]]; then
        if ! eval "$cmd $output_flags" > "$T1595_002J_RESULTS_DIR/nmap_output.txt" 2>&1; then
            [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] nmap scan failed" >&2
            return 3
        fi
    else
        if ! eval "$cmd" > "$T1595_002J_RESULTS_DIR/nmap_output.txt" 2>&1; then
            [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] nmap scan failed" >&2
            return 3
        fi
    fi

    local scan_end=$(date +%s)
    local scan_duration=$((scan_end - scan_start))

    # Traitement des résultats
    if [[ "nmap" == "nmap" ]] && [[ -f "$technical_details" ]]; then
        # Extraction des statistiques de base
        local hosts_up=$(grep -c "host.*state=\"up\"" "$technical_details" 2>/dev/null || echo "0")
        local ports_open=$(grep -c "port.*state=\"open\"" "$technical_details" 2>/dev/null || echo "0")
        local services_identified=$(grep -c "service.*name=" "$technical_details" 2>/dev/null || echo "0")
        local os_fingerprinted=$(grep -c "osmatch" "$technical_details" 2>/dev/null || echo "0")

        # Création du rapport JSON
        cat > "$scan_results" << JSON_EOF
{
  "technique_id": "T1595_002J",
  "technique_name": "vulnerability_scanning-nmap_banner_grabbing_scan",
  "scan_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "scan_type": "Banner Grabbing",
  "tool_used": "nmap",
  "scan_duration_seconds": $scan_duration,
  "configuration": {
    "service_detection": $T1595_002J_SERVICE_DETECTION,
    "version_scanning": $T1595_002J_VERSION_SCANNING,
    "os_detection": $T1595_002J_OS_DETECTION,
    "script_scanning": $T1595_002J_SCRIPT_SCANNING,
    "timing_template": "$T1595_002J_TIMING_TEMPLATE",
    "rate_limit": $T1595_002J_RATE_LIMIT
  },
  "results": {
    "hosts_discovered": $hosts_up,
    "ports_found": $ports_open,
    "services_identified": $services_identified,
    "os_fingerprinted": $os_fingerprinted,
    "scan_successful": true
  }
}
JSON_EOF

    elif [[ "nmap" == "zmap" ]] && [[ -f "$T1595_002J_RESULTS_DIR/zmap_results.csv" ]]; then
        # Traitement résultats Zmap
        local lines_count=$(wc -l < "$T1595_002J_RESULTS_DIR/zmap_results.csv" 2>/dev/null || echo "0")

        cat > "$scan_results" << JSON_EOF
{
  "technique_id": "T1595_002J",
  "technique_name": "vulnerability_scanning-nmap_banner_grabbing_scan",
  "scan_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "scan_type": "Banner Grabbing",
  "tool_used": "nmap",
  "scan_duration_seconds": $scan_duration,
  "configuration": {
    "rate_limit": $T1595_002J_RATE_LIMIT
  },
  "results": {
    "responses_received": $lines_count,
    "scan_successful": true
  }
}
JSON_EOF
    else
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] No scan results generated" >&2
        return 3
    fi

    return 0
}
# FUNCTION 4/4 : POSTCONDITION VERIFY

function Postcondition-Verify {
    echo "[DEBUG] Verifying postconditions for T1595_002J" >&2

    local results_dir="$T1595_002J_RESULTS_DIR"
    local scan_results="$results_dir/scan_results.json"

    # Vérification fichiers de sortie
    if [[ ! -f "$scan_results" ]]; then
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] Scan results file missing" >&2
        return 4
    fi

    # Validation contenu JSON
    if ! jq empty "$scan_results" 2>/dev/null; then
        [[ "$T1595_002J_SILENT_MODE" != "true" ]] && echo "[ERROR] Invalid JSON in scan results" >&2
        return 4
    fi

    # Création métadonnées d'exécution
    local metadata_file="$results_dir/metadata/execution_metadata.json"
    mkdir -p "$results_dir/metadata"

    cat > "$metadata_file" << META_EOF
{
  "execution_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "technique_id": "T1595_002J",
  "technique_name": "vulnerability_scanning-nmap_banner_grabbing_scan",
  "tool_used": "nmap",
  "execution_mode": "$T1595_002J_OUTPUT_MODE",
  "silent_mode": "$T1595_002J_SILENT_MODE",
  "results_directory": "$results_dir",
  "files_generated": $(find "$results_dir" -type f 2>/dev/null | wc -l),
  "total_size_bytes": $(du -sb "$results_dir" 2>/dev/null | cut -f1 || echo 0),
  "configuration_snapshot": {
    "targets": "$T1595_002J_TARGETS",
    "service_detection": $T1595_002J_SERVICE_DETECTION,
    "version_scanning": $T1595_002J_VERSION_SCANNING,
    "timing_template": "$T1595_002J_TIMING_TEMPLATE",
    "rate_limit": $T1595_002J_RATE_LIMIT
  }
}
META_EOF

    return 0
}
# MAIN EXECUTION ORCHESTRATOR

main() {
    # Orchestration des fonctions contractuelles
    Get-Configuration || exit $?
    Precondition-Check || exit $?
    Atomic-Action || exit $?

    # Sortie selon le mode
    case "$T1595_002J_OUTPUT_MODE" in
        "debug")
            echo "[DEBUG] vulnerability_scanning-nmap_banner_grabbing_scan completed successfully" >&2
            echo "[DEBUG] Results saved to: $T1595_002J_RESULTS_DIR" >&2
            find "$T1595_002J_RESULTS_DIR" -name "*.json" -o -name "*.xml" -o -name "*.csv" | while read -r file; do
                echo "[DEBUG] Generated: $file" >&2
            done
            ;;
        "simple")
            echo "[SUCCESS] vulnerability_scanning-nmap_banner_grabbing_scan completed" >&2
            echo "[INFO] Results saved to: $T1595_002J_RESULTS_DIR" >&2
            ;;
        "stealth")
            # Sortie minimale pour les opérations furtives
            ;;
        "silent")
            # Aucune sortie
            ;;
        *)
            echo "[INFO] vulnerability_scanning-nmap_banner_grabbing_scan completed" >&2
            ;;
    esac

    Postcondition-Verify || exit $?
}
# SCRIPT ENTRY POINT

main "$@"
